<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deathroll Arena</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
  body {
    background-color: #0e0e0e;
    color: #f8f8f8;
    font-family: "Trebuchet MS", Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  #topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #1a1a1a;
    padding: 10px;
    border-bottom: 2px solid #333;
  }

  #title {
    font-size: 20px;
    font-weight: bold;
    color: #ff8000;
    text-shadow: 0 0 6px #000;
  }

  #controls {
    display: flex;
    gap: 8px;
  }

  button {
    background: #222;
    color: #f8f8f8;
    border: 1px solid #444;
    padding: 6px 10px;
    cursor: pointer;
  }

  button:hover {
    background: #333;
  }

  #gold {
    font-weight: bold;
    margin-left: 8px;
  }

  .chatbox {
    height: 420px;
    overflow-y: auto;
    padding: 10px;
    background: #0b0b0b;
    border-bottom: 2px solid #333;
    font-size: 14px;
  }

  .line { margin-bottom: 6px; }

  .you { color: #1eff00; }
  .system { color: #ffd100; }
  .opponent { color: #ff4040; }
  .win { color: #1eff00; font-weight: bold; }
  .lose { color: #ff4040; font-weight: bold; }

  #inputbar {
    display: flex;
    padding: 10px;
    gap: 8px;
    background: #111;
  }

  input {
    flex: 1;
    background: #000;
    color: #fff;
    border: 1px solid #444;
    padding: 6px;
  }
</style>
</head>

<body>
<div class="container">
  <h1>Deathroll Arena</h1>

  <div class="chatbox" id="chat"></div>

  <input id="command" placeholder="Type /roll 1000 or chat..." autocomplete="off">

  <div class="controls">
    <button onclick="queueUp()">Queue</button>

    <button onclick="setBet(10)">Bet 10</button>
    <button onclick="setBet(50)">Bet 50</button>
    <button onclick="setBet(500)">Bet 500</button>
    <button onclick="customBet()">Custom</button>

    <button id="begBtn" onclick="begForGold()">Beg for Gold</button>
    <div class="gold" id="goldDisplay"></div>
  </div>

  <div class="hub">
    <button onclick="window.location.href='/'">Return to Main Hub</button>
  </div>
</div>

<script>
/* =======================
   EXISTING GOLD SYSTEM
   (unchanged)
======================= */

let gold = parseInt(localStorage.getItem("gold")) || 5000;
document.getElementById("goldDisplay").textContent = "ðŸª™ " + gold;

function saveGold() {
  localStorage.setItem("gold", gold);
}

const BEG_KEY = "deathroll_pvp_last_beg";

function begForGold() {
  const now = Date.now();
  const last = parseInt(localStorage.getItem(BEG_KEY) || "0", 10);

  if (now - last < 10000) {
    addLine("Beg is on cooldown.", "system");
    return;
  }

  localStorage.setItem(BEG_KEY, now);

  const roll = Math.random() * 100;
  let gained = roll < 65 ? 10 : roll < 85 ? 100 : roll < 95 ? 300 : 1000;

  gold += gained;
  saveGold();
  updateGold();

  addLine(`You beg pitifully and receive ${gained} gold.`, "system");
}

function updateGold() {
  document.getElementById("goldDisplay").textContent = "ðŸª™ " + gold;
}

/* =======================
   CHAT / UI (unchanged)
======================= */

const chatbox = document.getElementById("chat");
const input = document.getElementById("command");

function addLine(text, cls="you") {
  const div = document.createElement("div");
  div.className = `line ${cls}`;
  div.textContent = text;
  chatbox.appendChild(div);
  chatbox.scrollTop = chatbox.scrollHeight;
}

let currentBet = 0;

function setBet(amount) {
  if (gold <= 0) return;
  currentBet = Math.min(amount, gold);
  socket.emit("bet", currentBet);
  addLine(`You set a bet of ${currentBet} gold.`, "system");
}

function customBet() {
  if (gold <= 0) return;
  const amt = parseInt(prompt("Enter bet amount:"));
  if (!amt || amt <= 0) return;
  setBet(amt);
}

function sendInput() {
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  if (msg.startsWith("/roll")) {
    const parts = msg.split(" ");
    if (parts.length === 2) {
      const max = parseInt(parts[1]);
      if (!isNaN(max)) {
        socket.emit("roll", max);
      }
    }
    return;
  }

  socket.emit("chat", msg);
}

/* =======================
   MULTIPLAYER ADDITIONS
======================= */

const socket = io();
let myRole = null; // "PlayerA" or "PlayerB"

function queueUp() {
  socket.emit("queue");
  addLine("You queue for a deathroll match.", "system");
}

socket.on("role", role => {
  myRole = role;
  addLine(`You are ${role} (YOU).`, "you");
});

socket.on("result", data => {
  const bet = Number(data?.bet || 0);
  if (!bet) return; // no locked bet, no payout

  if (myRole === data.winner) {
    gold += bet;
    saveGold();
    updateGold();
    addLine(`You won ðŸª™ ${bet}.`, "win");
  } else if (myRole === data.loser) {
    gold = Math.max(0, gold - bet);
    saveGold();
    updateGold();
    addLine(`You lost ðŸª™ ${bet}.`, "lose");
  }
});

socket.on("chat", msg => {
  if (!msg || typeof msg !== "string") return;

  // Case 1: player chat lines "PlayerA: ..." or "PlayerB: ..."
  if (msg.startsWith("PlayerA:") || msg.startsWith("PlayerB:")) {
    const role = msg.startsWith("PlayerA:") ? "PlayerA" : "PlayerB";
    const rest = msg.slice(role.length); // keeps ":" + message
    const tag = (myRole === role) ? " (YOU)" : "";
    const pretty = `${role}${tag}${rest}`;

    addLine(pretty, (myRole === role) ? "you" : "opponent");
    return;
  }

  // Case 2: roll lines "PlayerA rolled ..." / "PlayerB rolled ..."
  if (msg.startsWith("PlayerA rolled") || msg.startsWith("PlayerB rolled")) {
    const role = msg.startsWith("PlayerA rolled") ? "PlayerA" : "PlayerB";
    const rest = msg.slice(role.length); // keeps " rolled ..."
    const tag = (myRole === role) ? " (YOU)" : "";
    const pretty = `${role}${tag}${rest}`;

    addLine(pretty, (myRole === role) ? "you" : "opponent");
    return;
  }

  // Anything else treat as system
  addLine(msg, "system");
});

socket.on("system", msg => {
  addLine(msg, "system");
});

input.addEventListener("keypress", e => {
  if (e.key === "Enter") sendInput();
});
</script>

</body>
</html>
