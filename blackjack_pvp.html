<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Blackjack Arena</title>
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1b1b1b 0%, #050505 65%);
      color: #eaeaea;
      font-family: "Lucida Console", "Courier New", monospace;
      display: flex;
      justify-content: center;
      padding: 24px 12px 40px;
    }

    .arena {
      width: min(900px, 96vw);
      background: #0a0a0a;
      border: 2px solid #2e2e2e;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      padding: 18px;
    }

    h1 {
      text-align: center;
      color: #ff8c42;
      text-transform: uppercase;
      font-size: 22px;
      margin: 0 0 12px;
      letter-spacing: 0.16em;
      text-shadow: 0 0 8px rgba(255, 140, 66, 0.45);
    }

    .status {
      border: 1px solid #2b2b2b;
      background: #111;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .status strong {
      color: #7ad7ff;
    }

    .chatbox {
      background: #050505;
      border: 1px solid #2a2a2a;
      height: 260px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .line {
      margin-bottom: 6px;
    }

    .p1 {
      color: #7ad7ff;
    }

    .p2 {
      color: #ff6b6b;
    }

    .system {
      color: #ffd166;
    }

    .win {
      color: #37ff8b;
      font-weight: bold;
    }

    .lose {
      color: #ff6b6b;
      font-weight: bold;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      background: #1c1c1c;
      color: #e6e6e6;
      border: 1px solid #444;
      padding: 6px 12px;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
    }

    button:hover {
      background: #2a2a2a;
    }

    input {
      width: 100%;
      padding: 8px;
      background: #0d0d0d;
      border: 1px solid #333;
      color: #f5f5f5;
      font-family: inherit;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="arena">
    <h1>Blackjack Arena</h1>

    <div class="status" id="status"></div>

    <div class="chatbox" id="chat"></div>

    <input id="command" placeholder="Type /deal, /hit, /stand, /switch" autocomplete="off">

    <div class="controls">
      <button onclick="queueUp()">Queue</button>
      <button onclick="setBet(5)">Bet 5</button>
      <button onclick="setBet(20)">Bet 20</button>
      <button onclick="setBet(100)">Bet 100</button>
      <button onclick="customBet()">Custom Bet</button>
      <button onclick="startRound()">Deal</button>
      <button onclick="hitPlayer()">Hit</button>
      <button onclick="standPlayer()">Stand</button>
      <button onclick="switchTurn()">Switch Turn</button>
    </div>

    <div class="footer">
      <div id="goldDisplay"></div>
      <div class="hub">
        <button onclick="window.location.href='/'">Return to Main Hub</button>
      </div>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("command");
    const status = document.getElementById("status");
    const goldDisplay = document.getElementById("goldDisplay");

    // IMPORTANT: shared with PvE blackjack via the SAME key "diamonds"
    let diamonds = parseInt(localStorage.getItem("diamonds") || "500", 10);

    const socket = io();
    let myRole = null;          // "P1" or "P2"
    let inRound = false;
    let activeRole = "P1";
    let currentBet = 0;
    let p1Hand = [];
    let p2Hand = [];
    let p1v = "--";
    let p2v = "--";

    function addLine(text, cls = "system") {
      const div = document.createElement("div");
      div.className = `line ${cls}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function updateDiamonds() {
      goldDisplay.textContent = `ðŸ’Ž ${diamonds.toLocaleString()} Diamonds`;
      localStorage.setItem("diamonds", String(diamonds));
    }

    function updateStatus() {
      const a = activeRole === "P1" ? "P1" : "P2";
      const youTag = (myRole === a) ? " (YOU)" : "";
      const p1Tag = (myRole === "P1") ? " (YOU)" : "";
      const p2Tag = (myRole === "P2") ? " (YOU)" : "";

      const p1Text = (p1Hand && p1Hand.length) ? `${p1Hand.join(" ")} (${p1v})` : "--";
      const p2Text = (p2Hand && p2Hand.length) ? `${p2Hand.join(" ")} (${p2v})` : "--";

      status.innerHTML = `
      <div><strong>Active:</strong> ${a}${youTag}</div>
      <div><strong>Bet:</strong> ${currentBet || 0} Diamonds each</div>
      <div><strong>P1${p1Tag}:</strong> ${p1Text}</div>
      <div><strong>P2${p2Tag}:</strong> ${p2Text}</div>
    `;
    }

    function queueUp() {
      socket.emit("bj_queue");
      addLine("You queue for Blackjack PvP.", "system");
    }

    function setBet(amount) {
      if (!myRole) {
        addLine("Queue first.", "system");
        return;
      }
      const bet = Math.max(0, Math.min(parseInt(amount, 10) || 0, diamonds));
      if (bet <= 0) {
        addLine("You don't have enough Diamonds for that bet.", "system");
        return;
      }
      currentBet = bet;
      socket.emit("bj_bet", bet);
      addLine(`You propose a bet of ${bet} Diamonds.`, "system");
      updateStatus();
    }

    function customBet() {
      const amt = parseInt(prompt("Enter bet amount:"), 10);
      if (!amt || amt <= 0) return;
      setBet(amt);
    }

    function startRound() {
      socket.emit("bj_deal");
    }

    function hitPlayer() {
      socket.emit("bj_hit");
    }

    function standPlayer() {
      socket.emit("bj_stand");
    }

    function switchTurn() {
      // Server controls turn order in PvP; keep button but don't break UI.
      addLine("Turn order is automatic in PvP.", "system");
    }

    function handleCommand(cmd) {
      switch (cmd) {
        case "/deal": startRound(); break;
        case "/hit": hitPlayer(); break;
        case "/stand": standPlayer(); break;
        case "/switch": switchTurn(); break;
        default:
          addLine("Unknown command. Try /deal, /hit, /stand.", "system");
      }
    }

    // ---- socket events ----
    socket.on("bj_role", role => {
      myRole = role;
      addLine(`Match joined: ${role} (YOU)`, "system");
      updateStatus();
    });

    socket.on("bj_system", msg => addLine(msg, "system"));

    socket.on("bj_state", s => {
      inRound = !!s.in_round;
      activeRole = s.active;
      currentBet = s.bet || currentBet;
      p1Hand = s.p1 || [];
      p2Hand = s.p2 || [];
      p1v = s.p1v ?? "--";
      p2v = s.p2v ?? "--";
      updateStatus();
    });

    socket.on("bj_result", r => {
      if (r.winner === null) {
        addLine("Push. No Diamonds change hands.", "system");
      } else if (myRole === r.winner) {
        diamonds += (r.bet || 0);
        addLine(`You win ${r.bet} Diamonds.`, "win");
      } else {
        diamonds = Math.max(0, diamonds - (r.bet || 0));
        addLine(`You lose ${r.bet} Diamonds.`, "lose");
      }
      updateDiamonds();
      updateStatus();
    });

    // Enter-to-send command
    input.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";
      handleCommand(msg);
    });

    // init
    updateDiamonds();
    updateStatus();
    addLine("Queue up for a real opponent. Both players set the same bet, then Deal.", "system");
  </script>

</body>

</html>